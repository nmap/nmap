use serde::{Deserialize, Serialize};
use chrono::{DateTime, Utc};
use std::net::IpAddr;
use uuid::Uuid;

/// Vulnerability severity levels
#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq, PartialOrd, Ord)]
#[serde(rename_all = "lowercase")]
pub enum Severity {
    Info,
    Low,
    Medium,
    High,
    Critical,
}

/// Vulnerability information
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Vulnerability {
    pub id: Uuid,
    pub scan_id: Uuid,
    pub host_id: Uuid,
    pub host_ip: IpAddr,
    pub port: u16,
    pub service: String,
    pub name: String,
    pub description: String,
    pub severity: Severity,
    pub cvss: Option<f32>, // 0.0 - 10.0
    pub cve: Option<String>, // CVE identifier
    pub cwe: Option<String>, // CWE identifier
    pub evidence: Vec<String>,
    pub remediation: String,
    pub references: Vec<String>,
    pub discovered_at: DateTime<Utc>,
}

impl Vulnerability {
    pub fn new(
        scan_id: Uuid,
        host_id: Uuid,
        host_ip: IpAddr,
        port: u16,
        service: String,
        name: String,
        description: String,
        severity: Severity,
    ) -> Self {
        Self {
            id: Uuid::new_v4(),
            scan_id,
            host_id,
            host_ip,
            port,
            service,
            name,
            description,
            severity,
            cvss: None,
            cve: None,
            cwe: None,
            evidence: Vec::new(),
            remediation: String::new(),
            references: Vec::new(),
            discovered_at: Utc::now(),
        }
    }

    pub fn with_cvss(mut self, cvss: f32) -> Self {
        self.cvss = Some(cvss);
        self
    }

    pub fn with_cve(mut self, cve: String) -> Self {
        self.cve = Some(cve);
        self
    }

    pub fn with_evidence(mut self, evidence: Vec<String>) -> Self {
        self.evidence = evidence;
        self
    }

    pub fn with_remediation(mut self, remediation: String) -> Self {
        self.remediation = remediation;
        self
    }

    pub fn with_references(mut self, references: Vec<String>) -> Self {
        self.references = references;
        self
    }
}

/// Response for listing vulnerabilities
#[derive(Debug, Serialize)]
pub struct ListVulnerabilitiesResponse {
    pub vulnerabilities: Vec<Vulnerability>,
    pub total: usize,
    pub by_severity: SeverityCounts,
}

/// Vulnerability counts by severity
#[derive(Debug, Serialize, Default)]
pub struct SeverityCounts {
    pub critical: usize,
    pub high: usize,
    pub medium: usize,
    pub low: usize,
    pub info: usize,
}

impl SeverityCounts {
    pub fn add(&mut self, severity: &Severity) {
        match severity {
            Severity::Critical => self.critical += 1,
            Severity::High => self.high += 1,
            Severity::Medium => self.medium += 1,
            Severity::Low => self.low += 1,
            Severity::Info => self.info += 1,
        }
    }
}
